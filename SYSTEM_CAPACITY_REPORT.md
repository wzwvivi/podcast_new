# 系统容量与并发能力评估报告

## 评估时间
2025-12-18 09:30 UTC

---

## 📊 当前系统配置

### **硬件资源**

| 资源 | 配置 | 使用情况 | 可用 |
|------|------|----------|------|
| **服务器** | AWS t3.small | - | - |
| **CPU** | 2 vCPU (Intel Xeon 2.50GHz) | ~0.5% (空闲) | 充足 |
| **内存** | 1910 MB (1.9 GB) | 1369 MB (71.7%) | **541 MB** |
| **磁盘** | 29 GB | 4.6 GB (17%) | 24 GB |

### **软件配置**

| 配置项 | 值 | 说明 |
|--------|-----|------|
| **并发限制** | 4个 | 同时处理的转录任务 |
| **切片长度** | 25分钟 | 优化后（从15分钟提升） |
| **FFmpeg线程** | 1个 | CPU使用优化 |
| **API模型** | Whisper + GPT | Groq API |

---

## 💾 存储使用情况

### **项目存储**
```
总大小: 356 MB

分解:
  - frontend:    149 MB (前端构建产物)
  - venv:        110 MB (Python环境)
  - temp_files:   93 MB (临时文件 ⚠️)
  - data:        3.6 MB (数据库)
  - static:      220 KB (静态文件)
  - backend.py:   76 KB (后端代码)
```

### **数据库情况**
```
数据库大小: 3.6 MB

记录统计:
  - 用户数量:    5 个
  - 历史记录:   22 条
  - 播主数量:    2 个
  - 单集数量:   30 个

单条记录: ~106 KB
历史记录总大小: ~2.3 MB
```

### **临时文件**
```
当前大小: 93 MB
文件数量: 8 个

⚠️ 注意: 发现未清理的临时文件
原因: 转录完成后的清理可能失败
建议: 定期清理 temp_files 目录
```

---

## 🔍 资源瓶颈分析

### **1. 内存是主要瓶颈 ⚠️**

```
总内存:   1910 MB
已使用:   1369 MB (71.7%)
可用:      541 MB

单个转录任务内存占用:
  - 基础进程:     ~80 MB
  - FFmpeg切片:   ~50-80 MB
  - API转录:      ~20-30 MB
  - Summary:      ~10-20 MB
  ─────────────────────────────
  总计:          ~160-210 MB

理论最大并发数:
  可用内存 541 MB ÷ 180 MB/任务 = 3个任务

⚠️ 关键限制: 内存不足以支持4个并发！
```

### **2. CPU使用情况**

```
当前CPU使用: 0.5% (空闲)
后端进程: 82 MB, 4.1% CPU

单个转录任务CPU占用:
  - FFmpeg切片(40秒):  80-90% (1线程限制)
  - API转录:           5-10%
  - Summary:           2-5%

4个并发时CPU峰值:
  - FFmpeg阶段: 80-90% (可控)
  - 其他阶段: 20-30%

✅ CPU不是瓶颈
```

### **3. 磁盘使用**

```
总空间: 29 GB
已用: 4.6 GB (17%)
剩余: 24 GB

磁盘增长速度:
  - 每个历史记录: ~106 KB
  - 每100个记录: ~10 MB
  - 可存储: ~226,000 条记录

✅ 磁盘充足
```

---

## 🎯 并发能力评估

### **理论计算**

#### **基于内存限制**
```
可用内存: 541 MB
单任务内存: 180 MB

最大并发 = 541 ÷ 180 = 3 个

⚠️ 当前配置(4个)已超出内存容量！
```

#### **基于CPU限制**
```
CPU核心: 2 vCPU
FFmpeg线程: 1个/任务
并行处理: 3个线程/任务

最大并发 = 不受CPU限制（FFmpeg已限制）
```

#### **基于API限制**
```
Groq限制: 30 requests/min

1小时播客 (25分钟切片):
  - ASR调用: 3次
  - Summary: 1次
  - 总计: 4次/任务

理论最大 = 30 ÷ 4 = 7-8 个任务/分钟

✅ API不是瓶颈
```

---

## ⚠️ 风险评估

### **当前配置风险**

| 风险项 | 风险等级 | 说明 |
|--------|----------|------|
| **内存不足** | 🔴 **高** | 541MB可用，4个并发需要720MB |
| **OOM崩溃** | 🟡 中 | 内存不足时可能触发OOM Killer |
| **临时文件堆积** | 🟡 中 | 93MB未清理文件 |
| **CPU争抢** | 🟢 低 | FFmpeg线程已限制 |
| **磁盘空间** | 🟢 低 | 充足 |

### **实际并发测试场景**

#### **场景1: 2个并发 (推荐)**
```
内存需求: 2 × 180MB = 360 MB
可用内存: 541 MB
内存余量: 181 MB (33%)

结果: ✅ 安全稳定
  - 内存充足
  - CPU使用可控
  - 系统响应流畅
```

#### **场景2: 3个并发 (最大安全值)**
```
内存需求: 3 × 180MB = 540 MB
可用内存: 541 MB
内存余量: 1 MB (0.2%)

结果: ⚠️ 接近极限
  - 内存紧张
  - 可能触发swap
  - 系统可能变慢
```

#### **场景3: 4个并发 (当前配置，超载)**
```
内存需求: 4 × 180MB = 720 MB
可用内存: 541 MB
内存缺口: -179 MB

结果: ❌ 高风险
  - 内存不足
  - 可能OOM
  - 系统不稳定
  - 部分任务可能失败
```

---

## 💡 优化建议

### **方案A: 调整并发数（立即执行）**

```python
# 当前配置
MAX_CONCURRENT_TRANSCRIPTIONS = 4  # ❌ 超载

# 推荐配置
MAX_CONCURRENT_TRANSCRIPTIONS = 2  # ✅ 安全稳定
```

**效果**:
- ✅ 内存使用: 360MB/541MB (66%)
- ✅ 稳定性: 高
- ✅ 支持用户: 10-15人（错峰使用）
- ✅ 无需额外成本

---

### **方案B: 升级服务器（长期）**

**推荐升级: t3.medium**

| 配置 | t3.small (当前) | t3.medium (推荐) |
|------|----------------|------------------|
| vCPU | 2 | 2 |
| 内存 | 2 GB | **4 GB** |
| 价格 | ~$15/月 | ~$30/月 |
| 推荐并发 | 2个 | **5-6个** |
| 最大并发 | 3个 | **8-10个** |

**升级效果**:
- ✅ 内存翻倍
- ✅ 支持5-6个稳定并发
- ✅ 支持30-50个用户
- ✅ 更大的安全余量

---

### **方案C: 清理优化（维护）**

1. **定期清理临时文件**
```bash
# 添加cron任务，每天清理超过1天的临时文件
0 2 * * * find /home/ubuntu/csy_podcast/temp_files/ -mtime +1 -delete
```

2. **优化数据库**
```bash
# 定期清理旧的历史记录（可选）
# 或者压缩历史记录的JSON数据
```

---

## 📈 用户容量预估

### **当前配置 (2个并发推荐)**

| 用户场景 | 支持人数 | 说明 |
|---------|---------|------|
| **同时在线** | 5-10人 | 浏览、查看历史 |
| **同时转录** | 2人 | 稳定安全 |
| **高峰排队** | 第3人等待 | 2-4分钟 |
| **日活用户** | 10-20人 | 错峰使用 |
| **总注册用户** | 50-100人 | 取决于活跃度 |

### **升级后 (t3.medium, 5个并发)**

| 用户场景 | 支持人数 | 说明 |
|---------|---------|------|
| **同时在线** | 20-30人 | 充足 |
| **同时转录** | 5人 | 流畅 |
| **高峰排队** | 第6人等待 | 短暂 |
| **日活用户** | 30-50人 | 舒适 |
| **总注册用户** | 200-500人 | 足够 |

---

## 🎯 最终建议

### **立即行动（今天）**

1. ✅ **调整并发数为2**
   ```python
   MAX_CONCURRENT_TRANSCRIPTIONS = 2
   ```

2. ✅ **添加临时文件清理**
   ```bash
   crontab -e
   # 添加: 0 2 * * * find /path/to/temp_files/ -mtime +1 -delete
   ```

3. ✅ **监控内存使用**
   ```bash
   watch -n 5 free -h
   ```

---

### **短期规划（1周内）**

- 📊 观察实际并发情况
- 📈 收集用户使用数据
- 🔍 监控内存峰值

---

### **中期规划（1个月内）**

**如果用户增长到15-20人**:
- 💰 升级到 t3.medium (~$30/月)
- 🚀 调整并发数为5-6
- 📈 支持30-50个用户

---

## 📊 结论

**当前状态**: ⚠️ **内存不足，并发配置过高**

**主要限制**: 内存 (541 MB可用，4个并发需要720MB)

**推荐配置**: 
- **并发数: 2个** (从4改为2)
- **适合: 10-20个日活用户**
- **成本: 无需额外投入**

**长期建议**: 
- **如果用户增长** → 升级到 t3.medium
- **投资回报** → 支持30-50用户，仅增加$15/月

---

生成时间: 2025-12-18 09:30 UTC

